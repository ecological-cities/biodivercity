<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Get and process landscape metrics • biodivercity</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Get and process landscape metrics">
<meta property="og:description" content="biodivercity">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">biodivercity</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="In-development version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/biodivercity.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/build-model_process-fauna.html">Process fauna survey data</a>
    </li>
    <li>
      <a href="../articles/build-model_process-landscape.html">Get and process landscape metrics</a>
    </li>
    <li>
      <a href="../articles/apply-model_predict-fauna.html">Predict fauna spatially</a>
    </li>
    <li>
      <a href="../articles/apply-model_validation.html">Cross-validation of models</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="build-model_process-landscape_files/header-attrs-2.11/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Get and process landscape metrics</h1>
                        <h4 class="author">Author</h4>
            
            <h4 class="date">2021-10-21</h4>
      
      
      <div class="hidden name"><code>build-model_process-landscape.Rmd</code></div>

    </div>

    
    
<div id="overview" class="section level2">
<h2 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h2>
<p><strong>Sections that require attention are marked with <u>ATTN</u></strong></p>
<ol style="list-style-type: decimal">
<li>Sentinel-2 data is first downloaded from the free and open-access Copernicus Open Access Hub via the package <code>sen2r</code>.</li>
<li>Images are mosaiced with the <code>insert-mosaic-function-here</code> function from this package.</li>
<li>Otsu thresholding is performed with the <code>threshold_otsu</code> function from this package.</li>
<li>
<code>lsm_perpoint</code> function summarises landscape metrics for provided geographical points at specified buffers.</li>
<li>
<code>get_roads_osm</code> and <code>get_buildings_osm</code> (<code>home2park</code> package is a dependency)</li>
</ol>
<p>Necessary input as sample dataset: - Sentinel-2 mosaic raster with NDVI and NDWI2 - Sampling points geojson - Sampling area (e.g. town) boundaries geojson</p>
</div>
<div id="using-sen2r-to-get-images-optional" class="section level2">
<h2 class="hasAnchor">
<a href="#using-sen2r-to-get-images-optional" class="anchor"></a>Using sen2r to get images (optional?)</h2>
<p>Images were downloaded with <code>sen2r</code>, it can be installed from <a href="https://cran.r-project.org/package=sen2r">CRAN</a>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># http://sen2r.ranghetti.info/articles/installation.html</span>
<span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"sen2r"</span><span class="op">)</span>

<span class="co"># install Sen2Cor software (atmospheric correction for Level-1C products)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">sen2r</span><span class="op">)</span>
<span class="fu">check_sen2r_deps</span><span class="op">(</span><span class="op">)</span> <span class="co"># check dependencies</span>
<span class="fu">install_sen2cor</span><span class="op">(</span>force <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co"># install via command instead of GUI</span></code></pre></div>
<p>Using <code>sen2r</code>: - Check their vignette</p>
<p>Desired indices: <strong>NDVI</strong>, <strong>NDWI2</strong></p>
</div>
<div id="processing-mosaics-of-downloaded-images" class="section level2">
<h2 class="hasAnchor">
<a href="#processing-mosaics-of-downloaded-images" class="anchor"></a>Processing mosaics of downloaded images</h2>
<p><strong>NOTE</strong>: This parallel-processed mosaic generation can be a new function? <strong>ATTN</strong>: would be difficult to include as sample since file sizes are large</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">directories</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.dirs</a></span><span class="op">(</span><span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"{dir_dataoutput}/processed/{which_round}"</span><span class="op">)</span>, recursive <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">directories</span> <span class="op">&lt;-</span> <span class="va">directories</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/basename.html">basename</a></span><span class="op">(</span><span class="va">directories</span><span class="op">)</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"CLD"</span>, <span class="st">"SCL"</span>, <span class="st">"RGB432B"</span><span class="op">)</span><span class="op">]</span> <span class="co"># rm directories not to be mosaiced</span>

<span class="co"># loop to process/export mosaic for each subdirectory</span>
<span class="co"># Note: doesn't make sense for SCL (surface classification map), CLD (cloud mask) &amp; RGB432B (RGB, clouds are white not NA) </span>
<span class="fu">foreach</span><span class="op">(</span>i <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">directories</span><span class="op">)</span>, <span class="co"># parallel loop</span>
                   .packages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"terra"</span>, <span class="st">"raster"</span><span class="op">)</span><span class="op">)</span> <span class="op">%dopar%</span> <span class="op">{</span> <span class="co"># foreach loops</span>
  
  <span class="co"># for each spectral index, import images as rasterStack</span>
  <span class="va">filepaths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">dir</a></span><span class="op">(</span>path <span class="op">=</span> <span class="va">directories</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span>, pattern<span class="op">=</span><span class="st">"*.tif$"</span><span class="op">)</span>
  <span class="va">filepaths</span> <span class="op">&lt;-</span> <span class="va">filepaths</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"mosaic"</span>, <span class="va">filepaths</span><span class="op">)</span><span class="op">]</span> <span class="co"># exclude previously generated/processed mosaics</span>
  
  <span class="va">images</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">filepaths</span>, <span class="va">rast</span><span class="op">)</span> <span class="co"># import as list</span>
  
  <span class="co"># don't run these for non-spectral indices</span>
  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"BOA"</span><span class="op">)</span>, <span class="va">directories</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
    <span class="va">images</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">images</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">/</span><span class="fl">10000</span><span class="op">)</span> <span class="co"># re-scale</span>
  <span class="op">}</span>
  
  <span class="co"># remove outliers (for specific spectral indices)</span>
  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/basename.html">basename</a></span><span class="op">(</span><span class="va">directories</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"NDVI"</span>, <span class="st">"NDWI2"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
    
    <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">images</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
        <span class="va">images</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">images</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;</span> <span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span>
        <span class="va">images</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">images</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span>
    <span class="op">}</span>
  <span class="op">}</span>
  
  <span class="co"># MOSAIC IMAGES</span>
  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/basename.html">basename</a></span><span class="op">(</span><span class="va">directories</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"BOA"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span> <span class="co"># if multiband, use raster::mosaic (weird error if use terra::mosaic)</span>
    
    <span class="va">images</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">filepaths</span>, <span class="fu">raster</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/raster/man/stack.html">stack</a></span><span class="op">)</span> <span class="co"># import as list, overwrite var</span>
    <span class="va">images</span><span class="op">$</span><span class="va">fun</span> <span class="op">&lt;-</span> <span class="va">mean</span>
    <span class="va">images</span><span class="op">$</span><span class="va">na.rm</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span>
    <span class="va">mosaic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="fu">raster</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/raster/man/mosaic.html">mosaic</a></span>, <span class="va">images</span><span class="op">)</span>
    
    <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/writeRaster.html">writeRaster</a></span><span class="op">(</span><span class="va">mosaic</span>, 
                <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">directories</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">"/mosaic.tif"</span><span class="op">)</span>,
                overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
    
    
  <span class="op">}</span><span class="kw">else</span><span class="op">{</span> <span class="co"># single band spectral index mosaics</span>
  
    <span class="va">mosaic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/terra/man/mosaic.html">mosaic</a></span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">images</span>, 
                                       <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="st">"mean"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> 
    <span class="fu">writeRaster</span><span class="op">(</span><span class="va">mosaic</span>, 
                <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">directories</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">"/mosaic.tif"</span><span class="op">)</span>,
                  wopt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>gdal<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"COMPRESS=LZW"</span><span class="op">)</span><span class="op">)</span>,
                  overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="op">}</span>
  
  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">" Exported mosaic for: "</span><span class="op">)</span>, <span class="va">filepaths</span>, 
      sep <span class="op">=</span> <span class="st">"\n"</span>, 
      file<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"parallel-processing-log.txt"</span><span class="op">)</span>, append<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
  
  
  <span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">mosaic</span>, <span class="va">images</span>, <span class="va">filepaths</span>, <span class="va">i</span>, <span class="va">j</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/gc.html">gc</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
<div id="otsus-thresholding-for-mosaicked-images" class="section level2">
<h2 class="hasAnchor">
<a href="#otsus-thresholding-for-mosaicked-images" class="anchor"></a>Otsu’s thresholding for mosaicked images</h2>
<p>To make sense of the raster data, the important information (e.g. landscape metrics) has to be isolated from the noise. Otsu’s thresholding (<a href="https://cw.fel.cvut.cz/wiki/_media/courses/a6m33bio/otsu.pdf">Otsu, 1979</a>) is an automated threshold finder that outperforms other techniques in terms of stability of results and processing speed, even with the presence of &gt;2 peaks in the histogram (<a href="https://www.tandfonline.com/doi/abs/10.1080/10106049.2018.1497094">Bouhennache et al., 2019</a>). The NDVI threshold for vegetation typically ranges from 0.2 to 0.4 (<a href="https://link.springer.com/article/10.1186/s40562-019-0132-4">Wong et al, 2019</a>; <a href="https://www.mdpi.com/2072-4292/11/2/105">Akbar et al, 2019</a>). A second thresholding is performed for the vegetation class to separate sparse from dense vegetation.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">dir</span>, <span class="va">rounds</span>,  <span class="st">"/NDVI/mosaic.tif"</span><span class="op">)</span>

<span class="co"># get threshold value via otsu method (assumes bimodal histogram)</span>
<span class="va">thresholds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">rounds</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">thresholds</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/threshold_otsu.html">threshold_otsu</a></span><span class="op">(</span><span class="va">files</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, levels <span class="op">=</span> <span class="fl">256</span><span class="op">)</span> <span class="co">#default levels = 256 for 8-bit images</span>
  <span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># apply first threshold &amp; get sub-classification threshold</span>
<span class="va">thresholds2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">files</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  
  <span class="va">raster</span> <span class="op">&lt;-</span> <span class="fu">rast</span><span class="op">(</span><span class="va">files</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>
  <span class="va">raster</span><span class="op">[</span><span class="va">raster</span> <span class="op">&lt;</span> <span class="va">thresholds</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span> <span class="co"># mask away those below threshold value</span>
  
  <span class="co"># second thresholding</span>
  <span class="va">thresholds2</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/threshold_otsu.html">threshold_otsu</a></span><span class="op">(</span><span class="va">raster</span>, levels <span class="op">=</span> <span class="fl">256</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">raster</span>, <span class="va">i</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># view thresholds</span>
<span class="va">thresholds</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>
<span class="co">#[value 1]</span>
<span class="va">thresholds</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>
<span class="co">#[value 2]</span></code></pre></div>
<div class="figure">
<img src="images/otsu-sample-plot.png" id="id" class="class" style="width:60.0%;height:60.0%" alt=""><p class="caption"><strong>Distribution of NDVI values across Singapore in Survey Round One (light green bars, dashed vertical lines) and Two (dark green bars, solid vertical lines).</strong> Based on image mosaic composed of data captured for Survey Round One and Survey Round Two. Vegetation was classified as pixel with values &gt;0.35 for Round One and &gt;0.36 for Round Two, via Otsu’s thresholding. Dense vegetation was classified as pixels with values &gt;0.62 for Round One and &gt;0.64 for Round Two, using the same method after the first round of classification.</p>
</div>
</div>
<div id="summarising-mosaic-landscape-metrics-within-buffer-distance-of-a-point" class="section level2">
<h2 class="hasAnchor">
<a href="#summarising-mosaic-landscape-metrics-within-buffer-distance-of-a-point" class="anchor"></a>Summarising mosaic landscape metrics within buffer distance of a point</h2>
<p>To build a model with point survey data, landscape metrics have to be isolated from a buffer distance around fauna sampling points. The <code>lsm_perpoint</code> function accepts a geographical input of sampling points and extracts surrounding landscape metrics from the processed mosaic into an output dataframe. Mosaicked rasters should be processed to classify respective land cover types as discrete values (e.g. vegetation classes may be classified <code>0</code> for non-vegetation; <code>1</code> for sparse; <code>2</code> for dense).</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">points</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span><span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"{dir_dataoutput}/sampling/points.geojson"</span><span class="op">)</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> 

<span class="va">circles_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">params</span><span class="op">$</span><span class="va">sen2r_points_buffers</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  
  <span class="va">circles_sf</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">st_buffer</span><span class="op">(</span><span class="va">points</span>, 
                            dist <span class="op">=</span> <span class="va">params</span><span class="op">$</span><span class="va">sen2r_points_buffers</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="co"># buffer distance</span>
                            nQuadSegs <span class="op">=</span> <span class="fl">30</span><span class="op">)</span> <span class="co"># line segments per quadrant</span>
  
  <span class="co"># circles_sf[[i]]$area_m2 &lt;- st_area(circles_sf[[i]]) # calc area</span>
  
  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">circles_sf</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">params</span><span class="op">$</span><span class="va">sen2r_points_buffers</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>
  
  <span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p><strong>ATTN</strong>: urban_classified no longer relevant as NVBI is not used?</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">circles</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lsm_perpoint.html">lsm_perpoint</a></span><span class="op">(</span>raster <span class="op">=</span> <span class="va">veg_classified</span>, points <span class="op">=</span> <span class="va">points</span>, 
                        buffer_sizes <span class="op">=</span> <span class="va">params</span><span class="op">$</span><span class="va">sen2r_points_buffers</span>,
                        class_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"vegSparse"</span>, <span class="st">"vegDense"</span><span class="op">)</span>,
                        class_values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>,
                        landscape_name <span class="op">=</span> <span class="st">"veg"</span>,
                        level <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"class"</span>, <span class="st">"landscape"</span><span class="op">)</span><span class="op">)</span> 

<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">circles</span><span class="op">)</span><span class="op">)</span><span class="op">{</span> <span class="co"># append to circles2 info to circles</span>
  <span class="va">circles</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">circles</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span>
    <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span>.cols <span class="op">=</span> <span class="fu">starts_with</span><span class="op">(</span><span class="st">"lsm_"</span><span class="op">)</span>, <span class="co"># make NA if percentage_inside &lt; 90</span>
                  <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">percentage_inside</span> <span class="op">&lt;</span> <span class="fl">90</span>, <span class="cn">NA</span>, <span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">percentage_inside</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">" Veg cover: Processed for sampling points\n"</span><span class="op">)</span>, 
          file<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"parallel-processing-log.txt"</span><span class="op">)</span>, append<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>



<span class="co"># circles2 &lt;- lsm_perpoint(raster = urban_classified, points = points, </span>
<span class="co">#                         buffer_sizes = params$sen2r_points_buffers,</span>
<span class="co">#                         class_names = c("urban"),</span>
<span class="co">#                         class_values = c(1),</span>
<span class="co">#                         landscape_name = "urban",</span>
<span class="co">#                         level = c("class", "landscape"))</span>
<span class="co"># cat(paste0(Sys.time(), " Urban cover: Processed for sampling points\n"), </span>
<span class="co">#           file=paste0("parallel-processing-log.txt"), append=TRUE)</span>
<span class="co"># </span>
<span class="co"># for(i in 1:length(circles)){ # append to circles2 info to circles</span>
<span class="co">#   circles[[i]] &lt;- circles[[i]] %&gt;%</span>
<span class="co">#     full_join(circles2[[i]] %&gt;% </span>
<span class="co">#                  mutate(across(.cols = starts_with("lsm_"), </span>
<span class="co">#                   ~ifelse(percentage_inside &lt; 90, NA, .))) %&gt;%</span>
<span class="co">#                 dplyr::select(-percentage_inside), </span>
<span class="co">#               by = c("point_id", "round"))</span>
<span class="co"># }</span>
<span class="co"># rm(circles2, i)</span>



<span class="va">circles2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lsm_perpoint.html">lsm_perpoint</a></span><span class="op">(</span>raster <span class="op">=</span> <span class="va">water_classified</span>, points <span class="op">=</span> <span class="va">points</span>, 
                        buffer_sizes <span class="op">=</span> <span class="va">params</span><span class="op">$</span><span class="va">sen2r_points_buffers</span>,
                        class_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"water"</span><span class="op">)</span>,
                        class_values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>,
                        landscape_name <span class="op">=</span> <span class="st">"water"</span>,
                        level <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"class"</span>, <span class="st">"landscape"</span><span class="op">)</span><span class="op">)</span> 
<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">" Water cover: Processed for sampling points\n"</span><span class="op">)</span>, 
          file<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"parallel-processing-log.txt"</span><span class="op">)</span>, append<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>

<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">circles</span><span class="op">)</span><span class="op">)</span><span class="op">{</span> <span class="co"># append to circles2 info to circles</span>
  <span class="va">circles</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">circles</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span>
    <span class="fu">full_join</span><span class="op">(</span><span class="va">circles2</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span> 
                 <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span>.cols <span class="op">=</span> <span class="fu">starts_with</span><span class="op">(</span><span class="st">"lsm_"</span><span class="op">)</span>, 
                  <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">percentage_inside</span> <span class="op">&lt;</span> <span class="fl">90</span>, <span class="cn">NA</span>, <span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
                <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">percentage_inside</span><span class="op">)</span>, 
              by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"point_id"</span>, <span class="st">"round"</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># combine geometry of circles_sf with circles</span>
<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">circles</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">circles</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">circles_sf</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span>
    <span class="fu">full_join</span><span class="op">(</span><span class="va">circles</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span>
                <span class="fu">mutate</span><span class="op">(</span>round <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">round</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
<div id="retrieving-osm-data-on-urban-metrics" class="section level2">
<h2 class="hasAnchor">
<a href="#retrieving-osm-data-on-urban-metrics" class="anchor"></a>Retrieving OSM data on urban metrics</h2>
<p>Urban landscape elements are retrieved from the freely-available OpenStreetMap (OSM) database. In the Sentinel-2 images, buildings would be represented by their building footprint as opposed to three-dimensional structures. The number of above-ground levels from OSM can act as a proxy for building height, especially in the residential buildings of Singapore where the floor-to-floor height is standardised, and complements the two-dimensional footprint. (Building height data may also be supplied by government databases if available (e.g. <a href="https://data.gov.sg/dataset/hdb-property-information">HDB Property Information from data.gov.sg</a>), otherwise OSM can be a great “universal” source.)</p>
<p>In this example, the building polygons and road lines are extracted from a set geographical boundary with the functions <code>get_buildings_osm</code> and <code>get_roads_osm</code>. <code>home2park</code>, a GitHub package, and <code>osmextract</code> are required dependencies for these functions and this package. Building <code>levels</code> was derived from <code>building:levels</code>; values were set to <code>1</code> if the extracted value was empty or <code>NA</code>, and set to <code>NA</code> if ≤ 0 (i.e. underground); values were then rounded up to the nearest whole number.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">osm_boundaries</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span><span class="st">"&lt;geo-boundaries&gt;.geojson"</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># ATTN: come back with sample dataset</span>
  <span class="co"># st_union() %&gt;% # merge all subzones</span>
  <span class="fu">st_as_sf</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">st_make_valid</span><span class="op">(</span><span class="op">)</span>

<span class="co"># get_roads_osm is not in home2park package. Need to load dependency libraries</span>

<span class="fu">foreach</span><span class="op">(</span>i <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">params</span><span class="op">$</span><span class="va">osm_download_dates</span><span class="op">)</span>, 
                   .packages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"home2park"</span>,
                                 <span class="st">"tidyverse"</span>, <span class="st">"sf"</span>, <span class="st">"osmextract"</span><span class="op">)</span><span class="op">)</span> <span class="op">%dopar%</span> <span class="op">{</span> 
  
  <span class="co"># buildings                   </span>
  <span class="fu"><a href="../reference/get_buildings_osm.html">get_buildings_osm</a></span><span class="op">(</span><span class="va">osm_boundaries</span>, 
                    date <span class="op">=</span> <span class="va">params</span><span class="op">$</span><span class="va">osm_download_dates</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,
                    dir_raw <span class="op">=</span> <span class="va">params</span><span class="op">$</span><span class="va">osm_dir_rawdata</span>,
                    filename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">dir_dataoutput</span>, <span class="st">"/landscape/osm/buildings_osm-polygons_"</span>, <span class="va">params</span><span class="op">$</span><span class="va">osm_download_dates</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">".geojson"</span><span class="op">)</span><span class="op">)</span>
              
  <span class="co"># roads</span>
  <span class="fu"><a href="../reference/get_roads_osm.html">get_roads_osm</a></span><span class="op">(</span><span class="va">osm_boundaries</span>, 
                date <span class="op">=</span> <span class="va">params</span><span class="op">$</span><span class="va">osm_download_dates</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,
                dir_raw <span class="op">=</span> <span class="va">params</span><span class="op">$</span><span class="va">osm_dir_rawdata</span>,
                filename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">dir_dataoutput</span>, <span class="st">"/landscape/osm/roads_osm-lines_"</span>, <span class="va">params</span><span class="op">$</span><span class="va">osm_download_dates</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">".geojson"</span><span class="op">)</span><span class="op">)</span>       
                     
  <span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span>                   
<span class="op">}</span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by First Last.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
