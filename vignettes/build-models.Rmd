---
title: "Build Models"
subtitle: "Train models that predict animal diversity from landscape data"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Build Models}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This article outlines a workflow to build predictive models of diversity for a chosen animal group. Fauna and landscape data should have already been prepared based on `vignette("process-animal")` and `vignette("process-landscape")`, respectively. Based on community ecology theory, we ‘decompose’ animal diversity into two components: (1) local (_Alpha_) diversity and (2) community (_Beta_) diversity. A predictive model will be built for each component.

<br>

```{r out.width = "70%", fig.align='center', dpi = 300, echo = FALSE}
knitr::include_graphics("framework_build-models.png", dpi = 300)
```
<center><b> Figure: Broad overview of the data workflow for a chosen animal group </b></center>

<br>

In the examples below, generalised linear mixed-effects models (GLMMs) are used, since linear models are generally simpler and provide better interpretability. Do note that other types of models/algorithms may also be used instead. Also, the full list of potential predictor variables may first be narrowed down; for example, random forest models may be used to select variables based on their relative importance in improving model performance (Arthur et al., 2010; Li et al., 2017). 
 
<br>

---

## 1. Local (_Alpha_) diversity

For a chosen animal group, local (_Alpha_) diversity is represented by the number of species recorded at sampling point locations (i.e., species density). The response variable specified within the GLMM is the number (count) of species.

First, load the necessary packages:

```{r load required libraries, message = FALSE, warning = FALSE, eval = FALSE}
library("biodivercity")
library("tidyverse") # to process/wrangle data
library("sf") # to process landscape data
library("tmap") # spatial visualisation

library("lme4") # mixed-effects modelling
library("MuMIn") # model selection & averaging
```

```{r load biodivercity while in dev, include = FALSE}
devtools::load_all()
library("tidyverse") 
library("sf") 
library("tmap")

library("lme4")
library("MuMIn")
```

Load the example datasets for birds (animal group 'Aves') recorded at sampling points across Singapore. `birds` is a dataframe containing the number of species aggregated across multiple surveys (i.e., species richness; column '`sprich`'), and `landscape` is a dataframe containing landscape predictors summarised within specified buffer radii. See `data(animal_surveys)` and `data(points_landscape)` for more details on the animal and landscape data, respectively.

```{r load example data}
filepath <- system.file("extdata", "build-models_alpha-diversity.Rdata", package="biodivercity")
load(filepath)
```

Pivot the `landscape_data` to wide format, with the prefix `r<radius>m_` (representing the radius size) appended to the column names of predictors:

```{r transform and combine data, message = FALSE}
landscape <- landscape %>% 
  pivot_longer(cols = c(starts_with("osm_"), starts_with("lsm_")),
               names_to = 'metric') %>% 
  pivot_wider(id_cols = c("town", "point_id"),
              names_from = c("radius_m", "metric"), 
              values_from = "value",
              names_glue = "r{radius_m}m_{metric}")

# combine bird and landscape data, then then scale/center variables
birds <- birds %>% 
  inner_join(landscape, by = c("town", "point_id")) 
birds_scaled <- birds %>% 
  mutate(across(.cols = where(is.numeric) & !sprich, scale))

head(birds_scaled) # view combined data
```

To fit the model as a GLMM, the function `MuMIn::dredge()` will be used. The function includes customisation options; for instance, the `subset` argument allows the user to exclude certain combinations of variables within the fitted model (i.e., apply constraints to possible models that may be built). In the following example, we do not allow the same landscape predictor summarised within multiple buffer radii to be present in the same model.

```{r create object to be supplied to function argument}

predictors <- grep("^r[0-9]+m_",  colnames(birds_scaled), value = TRUE) # get predictor names

# get rows with same predictors but different radii
var_comb <- combn(predictors, 2) %>% # unique combinations
  t() %>% 
  as.data.frame() %>%  # separate radii & predictors
  separate(V1, c("V1_radius", "V1_predictor"),
           sep = "(?<=[0-9])m_(?=[A-Za-z]*)", remove = FALSE) %>% 
  separate(V2, c("V2_radius", "V2_predictor"),
           sep = "(?<=[0-9])m_(?=[A-Za-z]*)", remove = FALSE) %>%
  rowwise() %>% 
  mutate(similar = grepl(V1_predictor, V2_predictor)) %>% 
  filter(isTRUE(similar))

# create object to be supplied to function argument
subset_vect <- paste(var_comb$V1, "&", var_comb$V2)
subset_exp <- parse(text = paste0("!(", paste(subset_vect, collapse = ") & !("), ")")) # function argument requires an expression

```

```{r include = FALSE}
rm(filepath, landscape,
   var_comb, subset_vect)
```

Next, we fit both a global (maximal) model and null model, in order to calculate the difference in Akaike Information Criterion (AIC) value within the function `MuMIn::dredge()`. In the example data, the '`town`' is specified as the random effect. The argument '`family`' is specified as `"poisson"`, since the response variable is count data. See the function `lme4::glmer()` for more details and information on its arguments.

```{r global and null model}
model_global <- 
  glmer(paste("sprich", "~", paste(predictors, collapse = " + "), 
              "+ (1|town) "),
        family = "poisson",
        na.action = "na.fail",
        control = lme4::glmerControl(optimizer = "bobyqa"),
        data = birds_scaled)

model_null <- 
  glmer(sprich ~ 1 + (1|town), family = "poisson", data = birds_scaled)
```

Automated model selection is performed using the function `MuMIn::dredge()`. Models are ranked based on their `AICc` value (AIC adjusted for small sample sizes). Model constraints are specified in the argument `subset`. To avoid a long runtime in this demonstration, we also limit the number of predictor variables in each model to four (argument `m.lim`).

```{r example dredge - dredge, message = FALSE, warning = FALSE}
model_glm <- dredge(model_global,
                    subset= subset_exp,
                    m.lim=c(NA,4), # max of 4 variables
                    rank="AICc")
```

The resulting object contains a model selection table, with each row representing a model that was fit. It is arranged in ascending order, based on AIC value (lower AIC value represents a 'better' model). A summary of the top models with values of ΔAIC < 2 can be viewed:

```{r table of best models}
bestmodels_info <- subset(model_glm, 
                         delta < 2, 
                         recalc.weights=FALSE)

knitr::kable(bestmodels_info, caption = glue::glue("**Summary of best models ranked based on automated model selection from `MuMIn::dredge()` (ΔAIC < 2).**")) %>%
  kableExtra::kable_styling("striped") %>% kableExtra::scroll_box(width = "100%", height = "300px")
```
We can also visualise the importance (based on sum-of-weights) and effect direction (based on coefficient value) for each variable within the top models:

```{r plot important variables, message = FALSE, dpi = 300, fig.width=5, fig.height=4, fig.align='center', out.width="100%"}

# average the effect of each predictor
effects <- data.frame(coef(bestmodels_info)[,-1]) %>% 
  summarise(across(everything(), ~ mean(.x, na.rm = TRUE))) %>% 
  pivot_longer(everything(), names_to = "var") %>% 
  mutate(effect = ifelse(value > 0, "Positive", "Negative"))

# get importance of each predictor
importances <- data.frame(MuMIn::sw(bestmodels_info)) %>% 
  rename(imp = MuMIn..sw.bestmodels_info.) %>% 
  rownames_to_column("var") %>% 
  left_join(effects, by = "var") %>% # join with effects
  mutate(effect = ifelse(is.na(effect), "Mixed (factor)", effect)) %>%
  mutate(effect = factor(effect, levels = c("Positive", "Negative", "Mixed (factor)")))

# plot
ggplot(data=importances, aes(x = imp, y = reorder(var, imp), 
                     fill = effect)) + 
  geom_bar(stat = "identity") +
  labs(x = "Sum of weights", y = "Variables") +
  scale_fill_manual(values = c("#4daf4a", "#e41a1c", "#377eb8"),
                    name = "Effect")

```

Finally, we can extract the models and `recipes::recipe()` objects for future use:

```{r}

# get list of best models
bestmodels <- MuMIn::get.models(bestmodels_info, subset = TRUE)

# create recipes object only with predictors within best models
predictors_best <- colnames(coef(bestmodels_info)[,-1])

birds <- birds %>% # original unscaled dataset
  dplyr::select(sprich, town, all_of(predictors_best)) # remove unnecessary columns

recipe_birds <- recipes::recipe(birds) %>% 
  recipes::update_role(sprich, new_role = "outcome") %>%
  recipes::update_role(town, new_role = "id") %>%
  recipes::update_role_requirements("id", bake = FALSE) %>%
  recipes::step_normalize(all_of(predictors_best)) %>% 
  recipes::prep()
```


```{r, include = FALSE}
rm(birds, birds_scaled, predictors, subset_exp,
   model_glm, model_global, model_null, 
   effects, importances,
   bestmodels, bestmodels_info, predictors_best, recipe_birds)
```

<br>

---

## 2. Community (_Beta_) diversity

Partial RDA models were used to model the relationship between animal communities and landscape predictors while considering also the inherent spatial structure of the animal communities. Similarly, variable selection by random forest was performed on the landscape variables prior to beta model building. In the following sections, the example variables were selected using the `randomForestSRC` and `MultivariateRandomForest` packages. After the first round of variable selection, the landscape predictors were summarised as Principal Component Analysis (PCA) axes while the spatial variation were quantified using Principle Coordinates of Neighbourhood Matrices (PCNM).

First, load the additional package `vegan` for beta diversity model building:

```{r load vegan, message = FALSE, warning = FALSE}
library("vegan")
```

As before, bird species density and landscape data for sampling points across six areas (towns) in Singapore will be analysed in this example. In this example dataset `beta_model_data`, animal and landscape datasets as processed in the previous two articles were combined. The variable selection output using random forest is also loaded from `beta_model_variables` to inform the principal component analysis (PCA) of the selected landscape variables later. 

```{r load data, message = FALSE, warning = FALSE}

# #Before package release:
# load("../inst/extdata/beta_model_data.Rdata")
# load("../inst/extdata/beta_model_variables.Rdata")
# load("../data/animal_observations.rda")
# load("../data/sampling_points.rda")

# Afrer package release:
filepath <- system.file("extdata", "beta_model_data.Rdata", package="biodivercity") #summarised landscape information per point
load(filepath)

filepath <- system.file("extdata", "beta_model_variables.Rdata", package="biodivercity") #variables selected from random forest
load(filepath)

data("animal_observations")
data("sampling_points")

sampling_points <- sampling_points %>% 
  filter(period == 1)
```

Next, we process the fauna datasets into acceptable formats for analyses.

```{r removing extra genus/family lvl records}
rmspp <- check_taxongrps(animal_observations, level = "point") 

animal_observations <- animal_observations %>%
  anti_join(rmspp, by = c("species" = "name","point_id", "period")) %>% 
  mutate(period = as.character(period))
```

An presence/absence community matrix is created from the observations to summarise total species incidence. 

```{r creating a presence/absence matrix, message = FALSE, warning = FALSE}
bird_com <- animal_observations %>% 
  filter(taxon == "Aves") %>%
  group_by(period, point_id, species) %>%
  summarise(n = sum(abundance)) %>%
  group_by(point_id, period) %>%
  pivot_wider(names_from = species, values_from = n) %>%
  replace(is.na(.),0) %>%
  ungroup()  %>%
  semi_join(beta_model_data, by = c("point_id", "period" = "round")) %>% # filtering for the same period
  as.data.frame(.) %>% 
  dplyr::select(-period, -point_id)

bird_com <- bird_com %>% 
  mutate(across(.cols = everything(), ~ case_when(. > 0 ~ 1,
                                                  . == 0 ~ 0))) %>% 
  select(which(colMeans(.)>0))
  
rm(rmspp)
```

After the `birds` dataset has been used to filter `bird_com`, coordinate information were added for PCNM analysis later.

```{r appending spatial information to landscape dataset, message = FALSE, warning = FALSE}
beta_model_data <- beta_model_data %>% 
  select(!c(town, round, priority, sprich)) %>% #keep only point_id and landscape variables
  arrange(point_id) %>% #sort alphabetically
  
  #adding coordinate information
  mutate(X = {(sampling_points$geometry[match(beta_model_data$point_id,sampling_points$point_id)] %>% sf::st_coordinates())[,2]}, 
         .after = point_id) %>% 
  mutate(Y = {(sampling_points$geometry[match(beta_model_data$point_id,sampling_points$point_id)] %>% sf::st_coordinates())[,1]},
         .after = X)
```

Using the variables selected by random forest, principal component analysis (PCA) is performed to summarise the landscape predictors. Only PCA axes with eigenvalues greater than one were retained. This step selects for PCA axes that account for more variance than the original variables on their own.

```{r diagnosis by PCA}

pca_birds <- beta_model_data %>% 
  dplyr::select(any_of(beta_model_variables$var)) %>% #select impt variables from RF
  prcomp(.,scale.=TRUE) #conduct pca

pca_selected_birds <- pca_birds$x[, which(pca_birds$sdev > 1)]

# biplot(pca_birds, choices=c(1,2))
```

Calculate the PCNM vectors using `Vegan::pcnm` and fit the animal community matrix against these PCNM vectors using `Vegan::rda`. To control for type I error while testing for significant predictors, significant PCNM vectors were first selected using a backwards, stepwise elimination method until all vectors has significance level smaller than the chosen significance level of 0.05 (Peres-Neto & Legendre, 2010). This was performed using `Vegan::ordistep`.

```{r PCNM, message = FALSE, warning = FALSE}
plots.xy <- cbind(beta_model_data$X, beta_model_data$Y)
raw_pcnm_birds <- pcnm(dist(plots.xy))

pcnm_scores_birds <-data.frame(scores(raw_pcnm_birds))

set.seed(123)

birds.pcnm.all <- rda(bird_com~., data = pcnm_scores_birds)
birds.pcnm.sub <- ordistep(birds.pcnm.all, direction = "backward", pout = 0.075)

```

Perform partial RDA was performed with the selected PCA axes as candidate explanatory variables and the significant PCNM vectors as covariates. Perform `Vegan::ordistep` to select for the significant PCA axes while accounting for the effects of the covariables in the model until all PCA axes has significance level smaller than the chosen significance level of 0.05. The final RDA model is fitted with the significant PC axes and PCNM vectors.

```{r stepwise selection with env vars, message = FALSE, warning = FALSE}
birds_selected <- cbind(pca_selected_birds, pcnm_scores_birds)

birds.rda.all <- update(birds.pcnm.sub, 
                        glue::glue("~. +", {paste((colnames(pca_selected_birds)), collapse=" +")}), #add selected PCA
                        data = birds_selected)

birds.rda.sub <- ordistep(birds.rda.all, direction = "backward") #assess p-value for dropping

birds.rda.sub$call

birds.rda.fin <- rda(bird_com ~ PC1 + PC2 + PC4 + PC6 + PC7 + PC8 + Condition(PCNM1 + PCNM2 + PCNM3 + PCNM4 + PCNM5), data = birds_selected)

```

The predictive _Beta_-diversity model also requires information on the average probability of each species occurring across all points.

```{r p-hats}
# fitted_126 <- fitted(birds1.rda.fin, model = "CCA")
p_hats_birds <- apply(bird_com, 2, mean)
p_hats_birds
```

The PCA axes, PCNM vectors, final RDA model and probability of species occurrence are saved out to be applied in the subsequent apply model section.

```{r save beta model objs, eval = FALSE}
save(pca_birds,
     raw_pcnm_birds,
     birds.rda.fin, 
     p_hats_birds,
     file = "./your/working/directory/beta_model_birds.Rdata")
```

<br>

---

## References

Arthur AD, Li J, Henry S & Cunningham SA (2010) Influence of woody vegetation on pollinator densities in oilseed Brassica fields in an Australian temperate landscape. _Basic and Applied Ecology_, _11_(5): 406–414.

Li J, Alvarez B, Siwabessy J, Tran M, Huang Z, Przeslawski R, Radke L, Howard F & Nichol S (2017) Application of random forest and generalised linear model and their hybrid methods with geostatistical techniques to count data: Predicting sponge species richness. _Environmental Modelling and Software_, _97_: 112–129.
