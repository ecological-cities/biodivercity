---
title: "Animals: Species-level Analyses"
subtitle: ""
author: "Author"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Animals: Species-level Analyses}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

Data generated from animal surveys can be summarised at multiple levels (e.g. area, period, animal groups). For a particular animal (taxon) group of interest, finer-grained summaries can also be generated—at the level of individual species.


First, load the necessary packages to run the analysis:

```{r load required libraries, message = FALSE, warning = FALSE, eval = FALSE}
library("biodivercity")
library("dplyr") # data processing
library("ggplot2") # data visualisation
```

```{r load biodivercity while in dev, include = FALSE}
devtools::load_all()
library("dplyr") # data processing
library("ggplot2") # data visualisation
```

## Prepare data

Load the example data. Refer to `help(animal_observations)` and `help(animal_surveys)` for more details on these datasets. 

```{r}
data("animal_observations")
data("animal_surveys")
```

Show group-level (family/genus) observations where all species in the group are observed at each sampling point. These entries present will later be removed at the respective points, in order to prevent over-counting the number of species. More details in the vignette _Process animal data_.

```{r show grp level observations}
remove <- check_taxongrps(animal_observations, level = "point")
remove
```

<br>

## Most abundant species

Summarise the animal surveys based on how many individuals of each species are present at each sampling point.

```{r most abundant animal species per town, message = FALSE, warning = FALSE, fig.width=8.0, fig.height =4.0, out.width="100%", dpi = 300, fig.cap="**Figure: Most abundant bird species within each area (town), per survey round.** Up to ten species are shown; species are arranged in descending order according to their cumulative counts."}

# no. of species per area
plot_fauna <- animal_observations %>%
  ungroup() %>%
  group_by(area, period, taxon, species) %>% 
  summarise(count = sum(abundance)) %>% 
  mutate(area = factor(area, levels = c("PG", "QT", "TP","JW", "BS", "WL"))) 
  

# Birds
order  <- plot_fauna %>% # summarise order of species
  filter(taxon == "Aves") %>%
  ungroup() %>%
  group_by(species) %>%
  summarise(order = sum(count))

plot_fauna %>%
  filter(taxon == "Aves") %>%

  # only plot top 10 species in each area 
  ungroup() %>%
  group_by(area, period) %>%
  slice_max(count, n = 10) %>%
  left_join(order) %>% # get order

  ggplot(aes(y = count, x = reorder(species, count))) +
    geom_col(width = 0.8, 
             color = "black", size =0.1) +
    facet_grid(taxon ~ area + period) +
    
    ylab("Number of individuals") +
    xlab("")+
    theme_bw()+
    theme(text = element_text(size=8.0),
          axis.text.y = element_text(face = "italic"),
          panel.grid.major.y = element_blank(),
          panel.grid.minor.y = element_blank(),
          panel.grid.minor.x = element_blank()) +
    coord_flip() +
    scale_y_continuous(expand = c(0,0), breaks = scales::breaks_pretty(n = 3))
```

<br>

## Most common species

Summarise the animal surveys based on whether each species is present at sampling points  (observed instances).

```{r common animal species per town, message = FALSE, warning = FALSE, fig.width=8.0, fig.height =4.0, out.width="100%", dpi = 300, fig.cap="**Figure: Most common bird species within each area (town), per survey round.** Up to ten species are shown; species are arranged in descending order according to the cumulative number of sampling points they are present in."}

# summarise sp density sampling pt per area
plot_fauna <- animal_observations %>%
  
  # add up same sp recorded at diff times in same survey, & diff cycles (result in counts of unique species per sampling pt in survey year)
  ungroup() %>%
  group_by(species, area, period, taxon, point_id) %>%
  summarise() %>% 
  
  # exclude genus/family lvl records if all sp within grp observed
  anti_join(remove, by = c("species" = "name","point_id", "period")) %>%
   
  # no of points that each sp occur (per taxa per area)
  ungroup() %>%
  group_by(species, area, period, taxon) %>% 
  summarise(count = n()) %>% 
  mutate(area = factor(area, levels = c("PG", "QT", "TP","JW", "BS", "WL"))) 

  
# Birds
order  <- plot_fauna %>% # summarise order of species
  filter(taxon == "Aves") %>%
  ungroup() %>%
  group_by(species) %>%
  summarise(order = sum(count))

plot_fauna %>%
  filter(taxon == "Aves") %>%

  # only plot top 10 species in each area 
  ungroup() %>%
  group_by(area, period) %>%
  slice_max(count, n = 10) %>%
  left_join(order) %>% # get order

  ggplot(aes(y = count, x = reorder(species, order))) +
    geom_col(width = 0.8, 
             color = "black", size =0.1) +
    facet_grid(taxon ~ area + period) +
    
    ylab("Number of sampling points") +
    xlab("")+
    theme_bw()+
    theme(text = element_text(size=8.0),
          axis.text.y = element_text(face = "italic"),
          panel.grid.major.y = element_blank(),
          panel.grid.minor.y = element_blank(),
          panel.grid.minor.x = element_blank()) +
    coord_flip() +
    scale_y_continuous(expand = c(0,0), breaks = scales::breaks_pretty(n = 4))

```

<br>

We can also visualise the most common species using a hierarchical tree map:

```{r visualise most common species using treemap, out.width="100%", dpi = 300, fig.width=8.0, fig.height =10.0, warning = FALSE, message = FALSE}

library(treemapify)

surveys_normalised <- animal_surveys %>%
  mutate(area = factor(area, levels = c("PG", "QT", "TP","JW", "BS", "WL"))) %>%
  mutate(taxon = factor(taxon, levels = c("Aves", "Lepidoptera", "Odonata", "Amphibia"))) %>%
  mutate(survey_id = as.factor(survey_id)) %>%
  mutate(point_id = as.factor(point_id)) %>% 
  filter(period == 1) # only for period 1!

fauna_normalised <- animal_observations %>%
  mutate(area = factor(area, levels = c("PG", "QT", "TP","JW", "BS", "WL"))) %>%
  mutate(taxon = factor(taxon, levels = c("Aves", "Lepidoptera", "Odonata", "Amphibia"))) %>%
  mutate(survey_id = factor(survey_id, 
                            levels = surveys_normalised$survey_id)) %>%
  mutate(point_id = factor(point_id, 
                           levels = unique(surveys_normalised$point_id))) %>% 
  filter(period == 1) # only for period 1!

# grp-lvl observations to remove
remove_area <- check_taxongrps(fauna_normalised, level = "area")
remove_point <- check_taxongrps(fauna_normalised, level = "point")
remove_normalised <- list(area = remove_area, point = remove_point)
rm(remove_area, remove_point)



# summarise sp density sampling pt per area
plot_fauna <- fauna_normalised %>%
  ungroup() %>%
  group_by(species, area, # period, 
           taxon, point_id) %>%
  summarise() %>% 
  
  # exclude genus/family lvl records if all sp within grp observed
  anti_join(remove_normalised$point, by = c("species" = "name","point_id" 
                                           #, # "period"
                                           )) %>%
  
  # no of points that each sp occur (per taxa per area)
  ungroup() %>%
  group_by(species, area, # period, 
           taxon) %>% 
  summarise(count = n())

  
# Birds - top 10 common spp in each area 
plot_fauna %>%
  filter(taxon == "Aves") %>%
  ungroup() %>%
  group_by(area #, period
           ) %>%
  slice_max(count, n = 10) %>% 
  
  ggplot(aes(area = count, fill = area, # label = species,
             subgroup = species)) +
    geom_treemap() +
    geom_treemap_subgroup_border(color = "white", size = 7) +
    geom_treemap_subgroup_text(place = "centre", 
                               size = 16,
                               # min.size = 12, 
                               grow = FALSE,
                               reflow = TRUE, # wrap text
                               alpha = 0.7, colour = "black",
                               fontface = "bold") +

  colorspace::scale_fill_discrete_qualitative("Harmonic") +
  
  labs(title="Urban birds of Singapore",
       caption="Most common spp. during surveys in 2016–2019",
       fill = NULL) +
  theme(aspect.ratio = 5/4,
        plot.background = element_blank(),
        panel.background = element_rect(fill = "transparent"),
        panel.border = element_blank(),
        rect = element_rect(fill = "transparent"),
        plot.title.position = 'plot', 
        plot.title = element_text(hjust = 0.5, size = 30, face = "bold"),
        plot.caption = element_text(size = 12, face = "italic"),
        legend.position="bottom",
        legend.title = element_text(face = "bold", size = 12),
        legend.text = element_text(size = 12)) +
    guides(fill = guide_legend(nrow = 1))
```

<br>

---

## References

The latest accepted taxonomic names and local statuses in the example data are based on the following sources:

- Birds: ebird Clements Checklist; The Singapore Red Data Book (Davison et al. 2008)
- Butterflies: A Field Guide to the Butterflies of Singapore (Khew, 2010)
- Odonates: The Dragonflies of Singapore: an updated checklist and revision of the national conservation statuses (Ngiam & Cheong, 2016)
- Amphibians: A Guide to the Amphibians & Reptiles of Singapore (Lim & Lim, 2002)

