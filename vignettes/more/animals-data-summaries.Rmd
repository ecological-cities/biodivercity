---
title: "Animals: Data summaries"
subtitle: "Compare local diversity between sampled areas"
author: "Author"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Animals: Data summaries}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Summarise survey data

Surveys are filtered to remove all surveys at sampling points that are surveyed less than three times. The remaining surveys are normalised by randomly removing sampling points from sampling zones to achieve similar point densities across all areas. Three surveys are then randomly selected per sampling point and taxon, and the removal process is repeated 30 times to obtain bootstrapped results. This normalised dataset is used to summarise species richness and species accumulation curves across sampling areas:

```{r sptally, eval = FALSE}
# BY POINT
normalised_perpt <- 
  foreach(i = seq_along(fauna_normalised), 
          .packages = "tidyverse") %dopar% {
 
  #get unique data to input to loop later
  unique <- surveys_normalised[[i]] %>%
    distinct(town, round, priority)
  
  results <- data.frame()
  
  for(j in 1:nrow(unique)){
  
    sptally_data <- 
      tally_observations(observations = fauna_normalised[[i]],
                        survey_ref = surveys_normalised[[i]],
                        specify_town = unique$town[j], 
                        specify_round = unique$round[j], 
                        specify_priority = unique$priority[j],
                        level = "point")
    
    # bind to plot_sac & overwrite
    results <- results %>%
      bind_rows(sptally_data)
    
    rm(sptally_data)
  }
            
  results                     
}

# summarise & stats
normalised_perpt <- normalised_perpt %>% 
  map_dfr(~ bind_rows(.), .id = "iteration") %>% # unlist 
  mutate(iteration = as.numeric(iteration)) %>% 
    
  # add iteration-level summaries
  group_by(iteration, 
           town, round, priority) %>% 
  summarise(mean = mean(n, na.rm = T) #,
            #se = sd(n, na.rm = T)/sqrt(length(n))
            ) %>% 
  mutate(type = "Point") %>%
  
  # for plotting
  mutate(town = factor(town, levels = c("PG", "QT", "TP","JW", "BS", "WL"))) %>%
  mutate(priority = factor(priority, levels = c("Aves", "Lepidoptera", "Odonata","Amphibia"))) %>%
  mutate(round = as.factor(round))
```

![Mean species richness (no. of species) per sampling point and survey, for each town and taxon. The error bars denote two standard deviations of the mean across all iterations. Note that the scale of the y-axis varies between the plots.](sample-stacked-bar-plot.png){#id .class width=80% height=80%}

```{r sac, eval = FALSE}

# loop across all bootstrapped iterations

plot_sac <- 
  foreach(i = seq_along(fauna), 
          .packages = "tidyverse") %dopar% {
  
  unique <- surveys[[i]] %>%
    distinct(town, round, priority)
            
  results <- data.frame()
  
  for(j in 1:nrow(unique)){
    
    sac_data <- calculate_sac(observations = fauna[[i]], 
                              survey_ref = surveys[[i]],
                              specify_town = unique$town[j], 
                              specify_round = unique$round[j], 
                              specify_priority = unique$priority[j])
    
    # bind to plot_sac & overwrite
    results <- results %>%
      bind_rows(sac_data)
    
    rm(sac_data)
  }
  
  results
}

# unlist & calc mean across iterations
plot_sac <- plot_sac %>% 
  map_dfr(~ bind_rows(.), .id = "iteration") %>% 
  mutate(iteration = as.numeric(iteration)) %>% 
  group_by(town, round, priority, sites) %>% 
  summarise(mean = mean(richness),
            sd = sd(richness, na.rm = TRUE))

```

![Species accumulation curves compare total, or 'gamma', diversity for the total sampling area, while accounting for differences in sampling effort. The mean species richness (line) and two standard deviations of the mean (shaded region) across all iterations are shown. Note that the scale of the y-axis varies between taxa.](sac-sample-plot.png){#id .class width=80% height=80%}
