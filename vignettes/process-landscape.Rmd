---
title: "Process Landscape Data"
subtitle: "Process remotely-sensed images"
author: "Edwin Tan"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Process Landscape Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Download open-source landscape data

### OpenStreetMap 

Urban landscape elements can be retrieved from the freely-available OpenStreetMap (OSM) database. Building polygons and road lines are extracted from a set geographical boundary with the functions `get_buildings_osm` and `get_roads_osm`. 

```{r download urban elements w parallel loops, eval = FALSE}
osm_boundaries <- data(boundaries) %>% 
  # st_union() %>% # merge all subzones
  st_as_sf() %>%
  st_make_valid()

foreach(i = seq_along(params$osm_download_dates), 
                   .packages = c("home2park",
                                 "tidyverse", "sf", "osmextract")) %dopar% { 
  
  # buildings                   
  get_buildings_osm(osm_boundaries, 
                    date = params$osm_download_dates[i],
                    dir_raw = params$osm_dir_rawdata,
                    filename = paste0(dir_dataoutput, "/landscape/osm/buildings_osm-polygons_", params$osm_download_dates[i], ".geojson"))
              
  # roads
  get_roads_osm(osm_boundaries, 
                date = params$osm_download_dates[i],
                dir_raw = params$osm_dir_rawdata,
                filename = paste0(dir_dataoutput, "/landscape/osm/roads_osm-lines_", params$osm_download_dates[i], ".geojson"))       
                     
  rm(i)                   
}
```

### Sentinel-2 satellite images

```{r get sen2r version, include = FALSE}
library(sen2r)
sen2r_version <- packageVersion("sen2R")
```

```{r intro para, results = 'asis', echo = FALSE}
cat(paste0("Landscape information is retrieved from the publicly available Sentinel-2 database using the `sen2r` package. As this is an external package unrelated to `biodivercity`, please also refer to the official repository for updated instructions. The package version used to generate this article is `sen2r_", sen2r_version, "`."))
```

To model for fauna species richness across the six towns from 2016 to 2019, the spatio-temporal selections can be set accordingly to download all available Sentinel-2 images with the `sen2r()` GUI interface. 

```{r sen2r setup, eval = FALSE}
# http://sen2r.ranghetti.info/articles/installation.html
install.packages("sen2r")

# install Sen2Cor software (atmospheric correction for Level-1C products)
library(sen2r)
check_sen2r_deps() # check dependencies
install_sen2cor(force = TRUE) # install via command instead of GUI

out_dir  <- glue::glue("{dir_dataoutput}/spatial/satellite-images/sen2r/sen2r_", {as.character(params$sen2r_date_range[1])}, "-to-", {as.character(params$sen2r_date_range[2])})

# run this after every successful download if there are still files in LTA not yet online, then subsequently check with provided safe_is_online() and sen2r():
out_paths <- sen2r(
  param_list = params$sen2r_params,
  timewindow = c(as.Date(params$sen2r_date_range[1]), as.Date(params$sen2r_date_range[2])),
  path_l2a = params$sen2r_dir_rawdata, # level-2A SAFE products
  path_l1c = params$sen2r_dir_rawdata, # level-1C SAFE products
  path_out = out_dir,
  path_indices = out_dir,
  extent_as_mask = TRUE,
  list_rgb = "RGB432B" # output RGB image
  # max_mask = 15,
  # list_indices = c("NDVI", "ARI")
  )
```

---

## Mosaic rasters

Raster files downloaded across multiple dates can be combined to create mosaics to account for cloud cover. This can be done with the file directories created by `sen2r()` in the `mosaic_sen2r()` function.

```{r mosaic generation, eval = FALSE}
 mosaic_sen2r(parent_dir = out_dir,
              exclude = NULL,
              rm_outlier = TRUE)
```

Downloaded rasters and the resulting mosaics contain raw information for the specified indices. To account for noise and classify pixel values, Otsu's thresholding (see article) can be used to define threshold values, where values above the threshold are regarded as a presence of the landscape type measured by an index.

```{r mosaic classification, eval = FALSE}
classify_image_binary(image = "out_dir/index/mosaic.tif",
                      threshold = "otsu")
```

With the classified mosaics, landscape metrics can then be extracted at the defined buffer distances around fauna sampling points. The sample datasets `data(points)`, `data(NDVI)` and `data(NDWI2)` contains the survey points and the classified mosaics for NDVI and NDWI2. 

```{r lsm_perpoint, eval = FALSE}
data(points)
veg_classified <- data(NDVI)
water_classified <- data(NDWI2)

circles <- lsm_perpoint(raster = veg_classified, 
                        points = points, 
                        buffer_sizes = c(50, 100, 126, 200, 400, 600, 800, 1000),
                        class_names = c("veg"),
                        class_values = c(1),
                        landscape_name = "veg",
                        level = c("class")) 

circles2 <- lsm_perpoint(raster = water_classified, 
                         points = points,
                         buffer_sizes = c(50, 100, 126, 200, 400, 600, 800, 1000),
                         class_names = c("water"),
                         class_values = c(1),
                         landscape_name = "water",
                         level = c("class")) 

for(i in 1:length(circles)){ # append to circles2 info to circles
  circles[[i]] <- circles[[i]] %>%
    full_join(circles2[[i]] %>% 
                 mutate(across(.cols = starts_with("lsm_"), 
                  ~ifelse(percentage_inside < 90, NA, .))) %>%
                dplyr::select(-percentage_inside), 
              by = c("point_id", "round"))
}
```

---
