---
title: "Process fauna survey data"
author: "Author"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Process fauna survey data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Overview

- `exclude_simulator.R`
- `filter_obs.R` 
- `check_taxongrps.R`
- `sac_extractor.R` 
- `sptally_extractor.R` 

## Quick subset of fauna survey data

The `filter_obs` function is meant for quick subsetting of fauna survey data and metadata that follows the following formats:
**ATTN**: Sample datasets required

```{r sample data table, eval = FALSE}
# chunk params should be "include = FALSE"

data <- data(survey_data)

kable(data, caption = "**Sample survey data format**") %>%
  kable_styling("striped") %>% scroll_box(width = "100%")
```

```{r sample info table, eval = FALSE}
# chunk params should be "include = FALSE"

info <- data(survey_info)

kable(info, caption = "**Sample survey info format**") %>%
  kable_styling("striped") %>% scroll_box(width = "100%")
```

`filter_obs` can be used to easily subset the data with respect to `town`, `round` and/or `priority`. In the context of this package, the parameters `town`, `round` and `priority` refer to the spatial, temporal and taxonomic grouping of the input data. Alternatively, these parameters can also be arbitrarily assigned to any existing groups.

```{r filter_obs, eval = FALSE}

bird <- filter_obs(observations = fauna, survey_ref = surveys,
                   specify_priority = "Aves")
butt <- filter_obs(observations = fauna, survey_ref = surveys,
                   specify_priority = "Lepidoptera")
dragon <- filter_obs(observations = fauna, survey_ref = surveys,
                     specify_priority = "Odonata")
frog <- filter_obs(observations = fauna, survey_ref = surveys,
                   specify_priority = "Amphibia")

```

## Assessing missing data with past records

Surveys during the COVID-19 circuit breaker period (Punggol and Queenstown Survey Round 2, Cycle 5) were not conducted. To examine the effect on the loss in observed species richness and density, surveys at Punggol and Queenstown in Cycle 5 during the previous survey year (Round 1, 2016/17) were randomly excluded from that full year's data. To examine the possible variation in species richness/density, a total of 100 scenarios (bootstrapped repetitions) were made, for the respective number of missed surveys for each taxon:  

- e.g. **Aves (birds):** 15 (PG) surveys excluded

```{r exclude_simulator, eval = FALSE}
exclude_bird_pg <- 15
rep <- 100

set.seed(123)

### BIRD ###
boot <- exclude_simulator(bird, surveys,
                          exclude_num = exclude_bird_pg, 
                          exclude_level = "survey",
                          specify_points = NULL, specify_towns = NULL,
                          specify_rounds = NULL, specify_cycles = 5, 
                          town_ignore = c("QT","TP", "JW", "BS", "WL"), # for PG
                          round_ignore = "2", 
                          cycle_ignore = NULL,
                          rep = rep)

# plot
plot_bird <- boot %>%
  pivot_longer(cols = num_range("iter", 1:ncol(boot)), # transform for plotting
               names_to = "iteration", values_to = "n") %>%
  mutate(town = "PG") %>%
  mutate(priority = "Aves")
plot_bird <- plot_bird %>%
  
  # get order
  left_join(plot_bird %>%
              ungroup() %>%
              group_by(species) %>%
              summarise(order = mean(full))) %>%
  drop_na(n) %>%

  ggplot(aes(x = reorder(species, order), y = n)) +
    
    facet_grid(priority ~ town) +
  
    geom_point(aes(y = full), shape=4, size=2.0,
                 color = "blue", alpha = 0.2) +
    
    geom_boxplot(width=0.1, color="black", alpha=0.2) +
    stat_summary(fun = mean, geom = "point", shape=5, size=1.5) + #mean value
  
    xlab("") +
    ylab("No. of sampling points") + 
    theme_bw() +
    theme(panel.grid.major.y = element_blank(),
          panel.grid.minor.y = element_blank(),
          panel.grid.minor.x = element_blank()) +
    coord_flip() +
    scale_y_continuous(expand = c(0,0))


# sp richness
sp_rich <- colSums(!is.na(boot[,-1]))
# mean(sp_rich) / nrow(boot)
# quantile(sp_rich)
sp_rich <- sp_rich %>%
  as_tibble() %>%
  rename(n = "value") %>%
  mutate(full = nrow(boot)) %>%
  mutate(priority = "Aves") %>%
  mutate(town = "PG")

rm(boot, sp_rich)

rm(exclude_bird_pg, rep)

```

## Checking fauna data entries for repeats or outdated names

**ATTN**: `check_taxongrps.R` no longer used in `0_Process-fauna.Rmd`?

## Summarising fauna data entries

### Stacked bar plots with error

Mean species richness (no. of species) per sampling point and survey, for each town and taxon. To normalise the point density per sampling zone, three surveys were randomly selected at each sampling point (per taxon and round), for 30 bootstrapped repetitions. The error bars denote two standard deviations of the mean across all iterations. Note that the scale of the y-axis varies between the plots.

```{r sptally, eval = FALSE}
# BY POINT
normalised_perpt <- 
  foreach(i = seq_along(fauna_normalised), 
          .packages = "tidyverse") %dopar% {
 
  #get unique data to input to loop later
  unique <- surveys_normalised[[i]] %>%
    distinct(town, round, priority)
  
  results <- data.frame()
  
  for(j in 1:nrow(unique)){
  
    sptally_data <- 
      sptally_extractor(observations = fauna_normalised[[i]],
                        survey_ref = surveys_normalised[[i]],
                        specify_town = unique$town[j], 
                        specify_round = unique$round[j], 
                        specify_priority = unique$priority[j],
                        level = "point")
    
    # bind to plot_sac & overwrite
    results <- results %>%
      bind_rows(sptally_data)
    
    rm(sptally_data)
  }
            
  results                     
}

# summarise & stats
normalised_perpt <- normalised_perpt %>% 
  map_dfr(~ bind_rows(.), .id = "iteration") %>% # unlist 
  mutate(iteration = as.numeric(iteration)) %>% 
    
  # add iteration-level summaries
  group_by(iteration, 
           town, round, priority) %>% 
  summarise(mean = mean(n, na.rm = T) #,
            #se = sd(n, na.rm = T)/sqrt(length(n))
            ) %>% 
  mutate(type = "Point") %>%
  
  # for plotting
  mutate(town = factor(town, levels = c("PG", "QT", "TP","JW", "BS", "WL"))) %>%
  mutate(priority = factor(priority, levels = c("Aves", "Lepidoptera", "Odonata","Amphibia"))) %>%
  mutate(round = as.factor(round))
```

### Species accumulation curves

Species accumulation curves for each town and taxon, after removal of data to normalise sampling point density. Three surveys were randomly selected at each sampling point (per taxon and round), for 30 bootstrapped repetitions. The mean species richness (line) and two standard deviations of the mean (shaded region) across all iterations are shown. Note that the scale of the y-axis varies between taxa.

```{r sac, eval = FALSE}

# loop across all bootstrapped iterations

plot_sac <- 
  foreach(i = seq_along(fauna), 
          .packages = "tidyverse") %dopar% {
  
  unique <- surveys[[i]] %>%
    distinct(town, round, priority)
            
  results <- data.frame()
  
  for(j in 1:nrow(unique)){
    
    sac_data <- sac_extractor(observations = fauna[[i]], 
                              survey_ref = surveys[[i]],
                              specify_town = unique$town[j], 
                              specify_round = unique$round[j], 
                              specify_priority = unique$priority[j])
    
    # bind to plot_sac & overwrite
    results <- results %>%
      bind_rows(sac_data)
    
    rm(sac_data)
  }
  
  results
}

# unlist & calc mean across iterations
plot_sac <- plot_sac %>% 
  map_dfr(~ bind_rows(.), .id = "iteration") %>% 
  mutate(iteration = as.numeric(iteration)) %>% 
  group_by(town, round, priority, sites) %>% 
  summarise(mean = mean(richness),
            sd = sd(richness, na.rm = TRUE))

```
