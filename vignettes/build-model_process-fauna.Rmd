---
title: "Process fauna survey data"
author: "Author"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
navbar: ~
vignette: >
  %\VignetteIndexEntry{Process fauna survey data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Overview

- `filter_obs` is a short function for quick subsetting of the large fauna survey dataframe.
- Surveys missed during the COVID-19 pandemic could have affected the observed species richness and density. `exclude_simulator` can be used to re-sample past surveys in the affected towns to estimate the decrease in species observed.
- `check_taxongrps`
- `sptally_extractor` and `sac_extractor` allow users to generate quick summaries of collected fauna data in the forms of mean species richness and species accumulation curves respectively. 

## Quick subset of fauna survey data

The `filter_obs` function is meant for quick subsetting of fauna survey data and metadata that follows the following formats:

```{r replacement code for vignette, eval = FALSE}
fauna <- data(fauna)
surveys <- data(surveys)

head(fauna)
head(surveys)
```

```{r sample data table, echo = FALSE, message = FALSE}
# show sample data in kable

library("knitr")
library("kableExtra")
library("tidyverse")

load("../data/fauna.RData")

# data <- data(fauna)
fauna <- fauna_normalised[[1]]

knitr::kable(head(fauna), caption = "**Sample survey data format**") %>%
  kable_styling("striped", font_size = 10) %>% scroll_box(width = "100%")
```


```{r sample info table, echo = FALSE, message = FALSE}
# show sample info in kable
load("../data/surveys.RData")

# info <- data(surveys)
surveys <- surveys_normalised[[1]]

knitr::kable(head(surveys), caption = "**Sample survey info format**") %>%
  kable_styling("striped", font_size = 10) %>% scroll_box(width = "100%")
```


`filter_obs` can be used to easily subset the data with respect to `town`, `round` and/or `priority`. In the context of this package, the parameters `town`, `round` and `priority` refer to the spatial, temporal and taxonomic grouping of the input data. Alternatively, these parameters can also be arbitrarily assigned to any existing groups.

```{r filter_obs vignette, eval = FALSE}
butterflies <- filter_obs(observations = fauna, survey_ref = surveys,
                   specify_priority = "Lepidoptera")
tampines <- filter_obs(observations = fauna, survey_ref = surveys,
                   specify_town = "TP")
round_2 <- filter_obs(observations = fauna, survey_ref = surveys,
                     specify_round = "2")

butterflies_tampines_round_2 <- filter_obs(observations = fauna, survey_ref = surveys,
                   specify_priority = "Lepidoptera",
                   specify_town = "TP",
                   specify_round = "2")

head(butterflies_tampines_round_2)
```

```{r filter_obs, echo = FALSE, message = FALSE}
source("../R/filter_obs.R")

butterflies_tampines_round_2 <- filter_obs(observations = fauna, survey_ref = surveys,
                   specify_priority = "Lepidoptera",
                   specify_town = "TP",
                   specify_round = "2")

knitr::kable(head(butterflies_tampines_round_2), caption = "**Observations of *butterflies* in *Tampines* from *2020-2021*.**") %>%
  kable_styling("striped", font_size = 10) %>% scroll_box(width = "100%")
```


## Assessing missing data with past records

When COVID-19 hit, fauna surveys scheduled within the Circuit Breaker period (Punggol and Queenstown Survey Round 2, Cycle 5) were not conducted. To simulate the effect on the loss in observed species richness and density with less surveys, the same number of surveys were randomly removed from the total survey number conducted during the same window of the previous survey year (Round 1, 2016/17). To examine the possible variation in species richness/density, bootstrapped repetitions were made for the respective number of missed surveys for each taxon.

- e.g. **Aves (birds):** 15 (PG) surveys excluded with 100 bootstrapping scenarios

```{r exclude_simulator, eval = FALSE}
exclude_bird_pg <- 15
rep <- 100

set.seed(123)

boot <- exclude_simulator(bird, surveys,
                          exclude_num = exclude_bird_pg, 
                          exclude_level = "survey",
                          specify_points = NULL, specify_towns = NULL,
                          specify_rounds = NULL, specify_cycles = 5, 
                          town_ignore = c("QT","TP", "JW", "BS", "WL"), # for PG
                          round_ignore = "2", 
                          cycle_ignore = NULL,
                          rep = rep)

# plot boxplot of affected species
plot_bird <- boot %>%
  pivot_longer(cols = num_range("iter", 1:ncol(boot)), # transform for plotting
               names_to = "iteration", values_to = "n") %>%
  mutate(town = "PG") %>%
  mutate(priority = "Aves")

plot_bird <- plot_bird %>%
  
  # get order
  left_join(plot_bird %>%
              ungroup() %>%
              group_by(species) %>%
              summarise(order = mean(full))) %>%
  drop_na(n) %>%

  ggplot(aes(x = reorder(species, order), y = n)) +
    
    facet_grid(priority ~ town) +
  
    geom_point(aes(y = full), shape=4, size=2.0,
                 color = "blue", alpha = 0.2) +
    
    geom_boxplot(width=0.1, color="black", alpha=0.2) +
    stat_summary(fun = mean, geom = "point", shape=5, size=1.5) + #mean value
  
    xlab("") +
    ylab("No. of sampling points") + 
    theme_bw() +
    theme(panel.grid.major.y = element_blank(),
          panel.grid.minor.y = element_blank(),
          panel.grid.minor.x = element_blank()) +
    coord_flip() +
    scale_y_continuous(expand = c(0,0))


# sp richness
sp_rich <- colSums(!is.na(boot[,-1]))
# mean(sp_rich) / nrow(boot)
# quantile(sp_rich)
sp_rich <- sp_rich %>%
  as_tibble() %>%
  rename(n = "value") %>%
  mutate(full = nrow(boot)) %>%
  mutate(priority = "Aves") %>%
  mutate(town = "PG")

# A function factory for getting integer y-axis values.
integer_breaks <- function(n = 5, ...) {
  fxn <- function(x) {
  breaks <- floor(pretty(x, n, ...))
  names(breaks) <- attr(breaks, "labels")
  breaks
  }
  return(fxn)
  }

# plot boxplot of expected species
sp_rich %>%
  mutate(priority = factor(priority, levels = c("Aves"))) %>%

  ggplot(aes(x = town, y = n)) +
    
    facet_wrap( ~ priority, scales = "free") +
    
    geom_point(aes(y = full), shape=4, size=3.0,
               color = "blue", alpha = 0.2) +
    geom_boxplot(width=0.2, color="black", alpha=0.2) +
    stat_summary(fun = mean, geom = "point", shape=5, size=2.0) + #mean value
  
    scale_y_continuous(breaks = integer_breaks()) +
    xlab("") +
    ylab("No. of species") + 
    theme_bw() +
    theme(panel.grid.major.x = element_blank(),
          panel.grid.minor.y = element_blank())
```

![**Regenerate with sample dataset.** Boxplot of no. of species (species richness) at Punggol in the first Survey Round (2016/17), if similar no. of missed surveys were randomly excluded in Cycle 5 (COVID-19 circuit breaker period in Survey Round 2, 2019/20). The blue cross denotes the counts across full dataset, while the diamond symbol denotes the mean counts across the 100 bootstrapped repetitions of scenarios with excluded data.](./images/exclude-sim-sample-plot.png)

## Checking fauna data entries for repeats or outdated names

**ATTN**: `check_taxongrps.R` no longer used in `0_Process-fauna.Rmd`?

## Summarising fauna data entries

To generate summary figures quickly for large survey data accumulated throughout the study period, `sptally_extractor` and `sac_extractor` can calculate the mean species richness and species accumulation curves respectively. `sptally_extractor` can be specific to the point or individual survey levels, while `sac_extractor` is calculated at the broader spatial grouping of `town` to represent surveys as sampling effort. Similar to the `filter_obs` function covered above, the same parameters of `town`, `round` and `priority` can be specified.

### Stacked bar plots with error

An example of the sample dataset summarised with `sptally_extractor` to create a stacked bar plot for each `town` and `priority` (taxon):

```{r sptally, eval = FALSE}
# BY POINT
normalised_perpt <- 
  foreach(i = seq_along(fauna_normalised), 
          .packages = "tidyverse") %dopar% {
 
  #get unique data to input to loop later
  unique <- surveys_normalised[[i]] %>%
    distinct(town, round, priority)
  
  results <- data.frame()
  
  for(j in 1:nrow(unique)){
  
    sptally_data <- 
      sptally_extractor(observations = fauna_normalised[[i]],
                        survey_ref = surveys_normalised[[i]],
                        specify_town = unique$town[j], 
                        specify_round = unique$round[j], 
                        specify_priority = unique$priority[j],
                        level = "point")
    
    # bind to plot_sac & overwrite
    results <- results %>%
      bind_rows(sptally_data)
    
    rm(sptally_data)
  }
            
  results                     
}

# summarise & stats
normalised_perpt <- normalised_perpt %>% 
  map_dfr(~ bind_rows(.), .id = "iteration") %>% # unlist 
  mutate(iteration = as.numeric(iteration)) %>% 
    
  # add iteration-level summaries
  group_by(iteration, 
           town, round, priority) %>% 
  summarise(mean = mean(n, na.rm = T) #,
            #se = sd(n, na.rm = T)/sqrt(length(n))
            ) %>% 
  mutate(type = "Point") %>%
  
  # for plotting
  mutate(town = factor(town, levels = c("PG", "QT", "TP","JW", "BS", "WL"))) %>%
  mutate(priority = factor(priority, levels = c("Aves", "Lepidoptera", "Odonata","Amphibia"))) %>%
  mutate(round = as.factor(round))
```

![Mean species richness (no. of species) per sampling point and survey, for each town and taxon. The error bars denote two standard deviations of the mean across all iterations. Note that the scale of the y-axis varies between the plots.](./images/sample-stacked-bar-plot.png){#id .class width=80% height=80%}

### Species accumulation curves

An example of the sample dataset summarised with `sac_extractor` to create a species accumulation curve for each `town` and `priority` (taxon):

```{r sac, eval = FALSE}

# loop across all bootstrapped iterations

plot_sac <- 
  foreach(i = seq_along(fauna), 
          .packages = "tidyverse") %dopar% {
  
  unique <- surveys[[i]] %>%
    distinct(town, round, priority)
            
  results <- data.frame()
  
  for(j in 1:nrow(unique)){
    
    sac_data <- sac_extractor(observations = fauna[[i]], 
                              survey_ref = surveys[[i]],
                              specify_town = unique$town[j], 
                              specify_round = unique$round[j], 
                              specify_priority = unique$priority[j])
    
    # bind to plot_sac & overwrite
    results <- results %>%
      bind_rows(sac_data)
    
    rm(sac_data)
  }
  
  results
}

# unlist & calc mean across iterations
plot_sac <- plot_sac %>% 
  map_dfr(~ bind_rows(.), .id = "iteration") %>% 
  mutate(iteration = as.numeric(iteration)) %>% 
  group_by(town, round, priority, sites) %>% 
  summarise(mean = mean(richness),
            sd = sd(richness, na.rm = TRUE))

```

![Species accumulation curves compare total, or ‘gamma’, diversity for the total sampling area, while accounting for differences in sampling effort. The mean species richness (line) and two standard deviations of the mean (shaded region) across all iterations are shown. Note that the scale of the y-axis varies between taxa.](./images/sac-sample-plot.png){#id .class width=80% height=80%}
