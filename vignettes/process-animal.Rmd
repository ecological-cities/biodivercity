---
title: "Process Animal Data"
subtitle: "Format, check and summarise data from animal surveys conducted at point locations"
author: "Edwin Tan"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Process Animal Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

Animal observations from on-site surveys can be used to build predictive models of animal diversity, or summarised to directly compare animal diversity between different areas or time periods. This article outlines the ways to format, check and process the animal data to build the predictive models.

<br>

```{r out.width = "70%", fig.align='center', dpi = 300, echo = FALSE}
knitr::include_graphics("framework_process-animal.png", dpi = 300)
```
<center><b> Figure: Broad overview of the data workflow for a chosen animal group </b></center>

<br>

First, load the necessary packages to run the analysis:

```{r load required libraries, message = FALSE, warning = FALSE, eval = FALSE}
library("biodivercity")
library("dplyr") # data processing
```

```{r load biodivercity while in dev, include = FALSE}
devtools::load_all()
```

<br>

---

## Data format

Data from animal surveys are organised into two separate tables: (1) a record of animal observations during each survey; and (2) reference information about each survey. The existence of (2) ensures that surveys with zero animal observations are accounted for. More details on how data are collected can be found in `vignette("animals-survey-protocols")`. These example data can be loaded by running the following code:

```{r}
data(animal_observations)
data(animal_surveys)
```

```{r sample data table, echo = FALSE, message = FALSE, warning = FALSE}

knitr::kable(head(animal_observations), caption = "**Table: Example showing animal observations recorded during surveys.** Each row represents a unique observation at a specified time, which includes the species name and count (abundance) of individuals. Refer to `help(animal_observations)` for more information.") %>%
  kableExtra::kable_styling("striped", font_size = 12, full_width = TRUE) %>%
  kableExtra::scroll_box(width = "100%")
```

<br>

```{r sample info table, echo = FALSE, message = FALSE}

knitr::kable(head(animal_surveys), caption = "**Table: Example showing the information recorded for each animal survey.** Each row represents a unique 30-minute survey. Refer to `help(animal_surveys)` for more information.") %>%
  kableExtra::kable_styling("striped", font_size = 12, full_width = TRUE) %>% 
  kableExtra::scroll_box(width = "100%")
```

<br>

If necessary, the convenience function  `filter_observations()` may be used to filter the animal survey data based on specified grouping variables (e.g. `area`, `period`, `taxon`). For example, observations from bird (`Aves`) surveys in Tampines (`TP`) conducted during 2020-2021 (survey period `2`) can be filtered as follows:

```{r filter_obs example, message = FALSE, warning = FALSE}

observations_subset <- filter_observations(observations = animal_observations, 
                                           survey_ref = animal_surveys,
                                           specify_taxon = "Aves",
                                           specify_area = "TP",
                                           specify_period = "2")

observations_subset
```

Note that the column `survey_id` will be converted to a factor variable, which includes levels that are not present in the observation data (i.e., no butterflies were observed during those surveys).

<br>

---

## Data checks

Checks can be performed to remove group-level observations, to prevent over-counting the number of species when summarising the data afterwards. For instance, if the _species_ name of an observed animal is unknown, surveyors may have recorded such observations at a higher (group) level of classification, such as the _family_ or _genus_. However, this same species recorded as a group-level entry may also be identified correctly (at the species-level) during other surveys at the same point/area (e.g., by another surveyor). When the number of species is tallied, it may result in a double-count of the particular animal species.

For example, there are two species of swallows observed across all points in the example datasetâ€“*Hirundo tahitica* and *Hirundo rustica*. *Hirundo spp.* is entered (in the `species` column) when the species cannot be identified with confidence: 

```{r check taxon groups 1, message = FALSE, warning = FALSE}
observations_swallows <- observations_subset %>% 
  filter(grepl("Hirundo", species)) %>% 
  group_by(area, point_id, species, family, genus) %>% 
  summarise()

observations_swallows
```

This would inflate the tallied number of species per point/area, since _Hirundo spp._ is a unique entry in the `species` column. For example, in the example dataset, a total of three swallow species would be reported within the Tampines (`TP`) area, rather than the two known to be present in the city of Singapore:

```{r message = FALSE}
observations_swallows %>% 
  group_by(area, species) %>% # tally by area
  summarise() %>%
  summarise(n())
```

One way to avoid such double-counting is to remove these group-level entries if all species in that particular classification group are observed, at the specified granularity of interest (`point` or `area`). The function `check_taxongrps()` identifies such group-level entries, as well as the total number of species within that grouping level (by referring to the columns `genus` and `family`). For example, for the example dataset of swallows within the Tampines (`TP`) area, we can check the number of unique species within the _Hirundo spp._ genus and _Hirundinidae_ family:

```{r}
to_remove <- check_taxongrps(observations_swallows, level = "area")
to_remove
```

These entries can subsequently be removed from `observations_swallows`, if they have been recorded in the `species` column: 

```{r}
filtered_observations <- observations_swallows %>%
  anti_join(to_remove, by = c("species" = "name"))

filtered_observations
```

To verify that these entries have been removed, we can re-tally the filtered observations. The number of species will be reduced by one:

```{r check taxon groups 2, message = FALSE, warning = FALSE}
filtered_observations %>% 
  group_by(area, species) %>% # tally by area
  summarise() %>%
  summarise(n())
```

<br>

---

## Summarise data

To build predictive models for a chosen animal group, the animal observations will need to be aggregated at the level of each sampling point. For example, we can tally the number of bird (animal group 'Aves') species per point using the function `tally_observations()`. Note that this function avoids double-counting group-level records, by acting as a wrapper to the function `check_taxongrps()` (see previous section).

```{r use tally_observations, message = FALSE}

animals_perpoint <- 
  tally_observations(observations = animal_observations, 
                     survey_ref = animal_surveys,
                     level = "point",
                     specify_taxon = "Aves")

head(animals_perpoint)
```

